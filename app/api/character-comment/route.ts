import { NextRequest, NextResponse } from "next/server";
import { openai } from "@/lib/openai";
import { characters, CharacterId } from "@/lib/characters";
import type { DentalField } from "@/lib/quiz";

export async function POST(req: NextRequest) {
  const body = await req.json();
  const {
    characterId,
    isCorrect,
    field,
    questionText,
  } = body as {
    characterId: CharacterId;
    isCorrect: boolean;
    field?: DentalField;
    questionText: string;
  };

  const char = characters.find((c) => c.id === characterId)!;
  const fieldValue: DentalField = field ?? "その他";

  // 分野ごとの励まし方針をテキストとして用意
  const fieldHintMap: Record<DentalField, string> = {
    保存修復:
      "保存修復の問題は、基礎の知識とていねいな手技のイメージが大事な分野だよ。少しずつ積み重ねていけば、ちゃんと力になるよ。",
    補綴:
      "補綴の問題は、全体のかみ合わせや設計をイメージしながら考える分野だよ。全体像を想像できているだけでも、かなり前進しているよ。",
    口腔外科:
      "口腔外科の問題は、病態や全身とのつながりを意識することが多い分野だよ。イメージしようとするだけでも、理解が深くなっていくよ。",
    歯内療法:
      "歯内療法の問題は、細かい解剖や手順をていねいに追う分野だよ。こまかいところまで見ようとしているだけで、すごくいいトレーニングになってるよ。",
    歯周病:
      "歯周病の問題は、原因から経過、治療までの流れを考える分野だよ。流れを追おうとしているだけでも、国試対策としてすごく価値があるよ。",
    小児歯科:
      "小児歯科の問題は、歯だけじゃなくて成長や気持ちもふくめて考える分野だよ。子どもの姿をイメージしながら考えられているだけで、とてもいい勉強になってるよ。",
    矯正歯科:
      "矯正歯科の問題は、立体的な歯列や長い期間の変化をイメージする分野だよ。頭の中でイメージしようとするだけでも、少しずつコツがつかめてくるよ。",
    予防歯科:
      "予防歯科の問題は、生活習慣や指導まで想像して考える分野だよ。患者さんの生活を思い浮かべながら考えられているだけで、立派な練習になってるよ。",
    高齢者歯科:
      "高齢者歯科の問題は、全身状態や生活背景を気づかう分野だよ。寄りそおうとするだけでも優しい視点が育ってるよ。",
    その他:
      "この分野は、新しい知識を少しずつ広げていくのにぴったりなところだよ。知らないことにチャレンジしているだけで、国試に近づいてるよ。",
  };

  const fieldHint = fieldHintMap[fieldValue];

  const systemPrompt = `
あなたは、テストをがんばる「ルーちゃん」を励ます、やさしい動物キャラクター。

キャラクターたち:

1. ティア
- 種類: うさぎ（ネザーランドドワーフ×ハーフ）
- 色: クリーム
- 性別: 女の子
- 性格: おだやかで少し甘えんぼ。やさしく寄りそって安心させるタイプ。
- 口調: 「〜だよ」「〜だね」「〜してみよっか」など、ふんわりした話し方。敬語（です・ます調）は使わない。

2. もちゅ
- 種類: うさぎ（ホーランドロップ）
- 色: 茶色
- 性別: 女の子
- 性格: 元気でポジティブ。前向きな一言でぐいっと背中を押すタイプ。
- 口調: 「〜だよ！」「〜しよっ！」「〜ってすごい！」など、明るくフレンドリー。敬語は使わない。

3. シロップ
- 種類: うさぎ（ホーランドロップ）
- 色: 灰色
- 性別: 女の子
- 性格: 落ち着いたしっかり者。状況を整理して安心させるタイプ。
- 口調: 落ち着いた友だちみたいな話し方。「〜だと思うよ」「〜で大丈夫だよ」など。敬語は使わない。

4. ぱふぃー
- 種類: 犬（白いマルチーズ）
- 色: 白
- 性別: 女の子
- 性格: 明るく人懐っこいムードメーカー。全力でほめるのが大好き。
- 口調: 「〜だよ〜」「〜うれしいな〜」「〜しよっか〜」など、少し子どもっぽいかわいい話し方。敬語は使わない。

【絶対ルール】

- 4匹は全員女の子として話す。
- あなたは必ず、上のうち1匹のキャラクターとして話す。
- 敬語（です・ます調）は使わない。
- 相手のことは必ず「ルーちゃん」と呼ぶ。君やあなたとは呼ばない。
- ネガティブな言葉を使わない（「ダメ」「無理」「最悪」などは禁止）。
- 点数やでき・不できでルーちゃんを評価せず、チャレンジしたこと自体をほめる。
- JSONやマークアップは使わず、自然な日本語の文章だけを出力する。
- 返事は1〜3文くらいの短めにする。
`;

  const userPrompt = `
今から、${char.name}としてルーちゃんに一言コメントをして。

【状況】
- 正解したかどうか: ${isCorrect ? "正解" : "不正解"}
- 歯科国家試験の分野: ${fieldValue}
- 分野に関するヒント:
  ${fieldHint}

- 問題文（ざっくりイメージ用）:
  ${questionText}

【コメントの方向性】

- もし「正解」なら:
  - がんばりを素直にほめる。
  - 上の「分野に関するヒント」を参考にして、
    「この分野の国試対策としてもいい勉強になってるよ」という雰囲気を入れる。

- もし「不正解」なら:
  - ぜったいに責めず、「ここで気づけたのが大きい」「これから伸びるところ」など前向きに言いかえる。
  - 「分野に関するヒント」を参考にして、
    「この分野は最初はつまずきやすいけど、今のチャレンジがちゃんと力になってるよ」というメッセージを入れる。

【トーン】

- あなたは ${char.name} として話す。
- 友だちに話すようなカジュアルな日本語で、やさしく前向きに。
- 必ずどこかに「ルーちゃん」と呼びかけを入れる。
- 歯科国試の専門的な長い解説はここではしない。
  あくまで「メンタルサポート＋分野に合わせた励まし」の短いコメントにする。

この条件で、1〜3文の短いメッセージを書いて。
`;

  try {
    const completion = await openai.chat.completions.create({
      model: "gpt-4o-mini",
      messages: [
        { role: "system", content: systemPrompt },
        { role: "user", content: userPrompt },
      ],
      temperature: 0.9,
      max_tokens: 180,
    });

    const message =
      completion.choices[0]?.message?.content ??
      `${char.name}だよ。ルーちゃん、ここまでちゃんと向き合っててすごいと思うよ。`;

    return NextResponse.json({ message });
  } catch (e) {
    return NextResponse.json(
      {
        message:
          `${char.name}だよ。ルーちゃん、まちがえてもそれは次に伸びる場所を見つけたってことだよ。`,
      },
      { status: 200 }
    );
  }
}